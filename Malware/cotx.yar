rule cotx {
   meta:
      author = "str_yaragen"
      date = "2020-01-14"
   strings:
      $s0 = "%s\\cmd.exe" ascii wide //10.27
      $s1 = "reg delete HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v %s /f" ascii wide //9.41
      $s2 = "reg delete HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v %s /f" ascii wide //9.39
      $s3 = "CONNECT %s:%d HTTP/1.0" ascii wide //9.07
      $s4 = "\\pxry.dat" ascii wide //8.93
      $s5 = "Error:cmd.exe not exist!" ascii wide //8.90
      $s7 = "taskkill /f /pid %s" ascii wide //8.69
      $s8 = "taskkill /f /pid %d" ascii wide //8.69
      $s9 = "1.187.1.187" ascii wide //8.67
      $s10 = "HOST: %s" ascii wide //8.66
      $s11 = "taskkill /pid %d /f && del /f/s/q \"%s\"" ascii wide //8.37
      $s12 = "copy failed:" ascii wide //8.37
      $s13 = "is not exist!" ascii wide //8.36
      $s14 = "%hs:%d" ascii wide //8.35
      $s15 = "placement delete closure'" ascii wide //8.34
      $s16 = "is already exist!" ascii wide //8.34
      $s17 = "cannot delete file:" ascii wide //8.32
      $s18 = "cannot delete directory:" ascii wide //8.31
      $s19 = "Error:You have in a shell" ascii wide //8.26
      $s20 = "Error:You have in a shell" ascii wide //8.26
      $s21 = "OpenProcessToken Error: %d" ascii wide //8.25
      $s22 = "Proxy-Authorization: Basic %s" ascii wide //8.24
      $s23 = "Cmd shell is not running" ascii wide //8.24
      $s24 = "Domain:    [%s]" ascii wide //8.24
      $s25 = "LogonUser: [%s]" ascii wide //8.21
      $s26 = "You have no permission to write on 1" ascii wide //8.18
      $s27 = "You have no permission to write on 2" ascii wide //8.18
      $s28 = "You have no permission to write on 3" ascii wide //8.18
      $s29 = "You have no permission to write on 4" ascii wide //8.18
      $s30 = "You have no permission to write on 5" ascii wide //8.18
      $s31 = "cannot upload file to %s" ascii wide //8.16
      $s32 = "You have no permission to write on" ascii wide //8.15
   condition:
      uint16(0) == 0x5A4D and  10 of them 
}

rule cotx_and_keyboy {
   meta:
      author = "str_yaragen"
      date = "2020-01-15"
      hash1 = "61c8cfbf48ca06a8a3590a53321fda7dbc8f5fb3473ae36d2d272d5015a931f3"
      hash2 = "f0375d1f5b1a05d9c92c8f8d49e92158c065230693b1f882dfa5d4d901338dc3"
      hash3 = "6e900e5b6dc4f21a004c5b5908c81f055db0d7026b3c5e105708586f85d3e334"
      hash4 = "1d716cee0f318ee14d7c3b946a4626a1afe6bb47f69668065e00e099be362e22"
      hash5 = "e54728dfbb3b26bbdf1a25b48e45f621fd11e896f21596f9087552a5c7b5112e"
   strings:
      $s0 = "%s\\cmd.exe" ascii wide //10.27
      $s1 = "taskkill /f /pid %s" ascii wide //8.69
      $s2 = "is not exist!" ascii wide //8.36
      $s3 = "OpenProcessToken Error: %d" ascii wide //8.25
      $s4 = "Domain:    [%s]" ascii wide //8.24
      $s5 = "LogonUser: [%s]" ascii wide //8.21
      $s9 = "DRIVE_CDROM" ascii wide //7.38
      $s10 = "DRIVE_FIX" ascii wide //7.38
      $s12 = "DRIVE_UNKNOWN" ascii wide //7.36
      $s13 = "DRIVE_REMOTE" ascii wide //7.36
      $s14 = "DRIVE_REMOVABLE" ascii wide //7.33
      $s15 = "RAM Driver" ascii wide //7.32
      $s21 = "Proc-Type" ascii wide //6.60
      $s22 = "/emailAddress=" ascii wide //6.51
      $s23 = "/serialNumber=" ascii wide //6.49
      $s24 = "WriteFile session error!" ascii wide //6.45
      $s26 = "NODISK" ascii wide //6.21
      $s27 = "rd /s/q \"%s\"" ascii wide //5.76
      $s28 = "rd /s/q \"%s\\*\"" ascii wide //5.76
   condition:
      uint16(0) == 0x5A4D and 10 of them 
}


rule KeyBoy_876_0x4e20000 {
   meta:
      description = "Detects KeyBoy Backdoor"
      author = "Markus Neis, Florian Roth"
      reference = "https://blog.trendmicro.com/trendlabs-security-intelligence/tropic-trooper-new-strategy/"
      date = "2018-03-26"
      hash1 = "6e900e5b6dc4f21a004c5b5908c81f055db0d7026b3c5e105708586f85d3e334"
   strings:
      $x1 = "%s\\rundll32.exe %s ServiceTake %s %s" fullword ascii
      $x2 = "Cmd shell is not running,or your cmd is error!"  ascii wide
      $x3 = "Take Screen Error,May no user login!" fullword ascii
      $x4 = "Get logon user fail!" fullword ascii
      $x5 = "8. LoginPasswd:%s" fullword ascii
      $x6 = "Take Screen Error,service dll not exists" fullword ascii

      $s1 = "taskkill /f /pid %s" fullword ascii
      $s2 = "TClient.exe" fullword ascii
      $s3 = "%s\\wab32res.dll" fullword ascii
      $s4 = "%s\\rasauto.dll" fullword ascii
      $s5 = "Download file:%s index:%d" fullword ascii
      $s6 = "LogonUser: [%s]" fullword ascii
   condition:
      uint16(0) == 0x5a4d and filesize < 2000KB and (
        1 of ($x*) or
        3 of them
      )
}
rule cotx_te {
   meta:
      author = "yara_gen"
      date = "2020-01-15"
      hash1 = "61c8cfbf48ca06a8a3590a53321fda7dbc8f5fb3473ae36d2d272d5015a931f3"
      hash2 = "f0375d1f5b1a05d9c92c8f8d49e92158c065230693b1f882dfa5d4d901338dc3"
      hash3 = "6e900e5b6dc4f21a004c5b5908c81f055db0d7026b3c5e105708586f85d3e334"
      hash4 = "1d716cee0f318ee14d7c3b946a4626a1afe6bb47f69668065e00e099be362e22"
      hash5 = "e54728dfbb3b26bbdf1a25b48e45f621fd11e896f21596f9087552a5c7b5112e"
   strings:
      $s0 = "%s\\cmd.exe" ascii wide //10.27
      $s1 = "taskkill /f /pid %s" ascii wide //8.69
      $s2 = "is not exist!" ascii wide //8.36
      $s3 = "OpenProcessToken Error: %d" ascii wide //8.25
      $s4 = "Domain:    [%s]" ascii wide //8.24
      $s5 = "LogonUser: [%s]" ascii wide //8.21
      $s6 = "AES128-SHA256" ascii wide //7.61
      $s7 = "-----END ENCRYPTED PRIVATE KEY-----" ascii wide //7.44
      $s8 = "-----BEGIN ENCRYPTED PRIVATE KEY-----" ascii wide //7.42
      $s9 = "DRIVE_CDROM" ascii wide //7.38
      $s10 = "DRIVE_FIX" ascii wide //7.38
      $s11 = "-----BEGIN DSA PRIVATE KEY-----" ascii wide //7.37
      $s12 = "DRIVE_UNKNOWN" ascii wide //7.36
      $s13 = "DRIVE_REMOTE" ascii wide //7.36
      $s14 = "DRIVE_REMOVABLE" ascii wide //7.33
      $s15 = "RAM Driver" ascii wide //7.32
      $s16 = "deflate 1.2.3 Copyright 1995-2005 Jean-loup Gailly" ascii wide //7.30
      $s17 = "-----END DSA PRIVATE KEY-----" ascii wide //7.29
      $s18 = "inflate 1.2.3 Copyright 1995-2005 Mark Adler" ascii wide //7.27
      $s19 = "AES128-SHA" ascii wide //6.79
      $s20 = "AES256-SHA" ascii wide //6.79
      $s21 = "Proc-Type" ascii wide //6.60
      $s22 = "/emailAddress=" ascii wide //6.51
      $s23 = "/serialNumber=" ascii wide //6.49
      $s24 = "WriteFile session error!" ascii wide //6.45
      $s25 = "+_l9Glrd" ascii wide //6.39
      $s26 = "NODISK" ascii wide //6.21
      $s27 = "rd /s/q \"%s\"" ascii wide //5.76
      $s28 = "rd /s/q \"%s\\*\"" ascii wide //5.76
   condition:
      uint16(0) == 0x5A4D and 10 of them 
}
